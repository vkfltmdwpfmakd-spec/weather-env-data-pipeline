{
 "cells": [
  {
   "cell_type": "code",
   "execution_count": 1,
   "id": "2ffb5fb2-c7be-4c11-8ff4-d5b839502c0e",
   "metadata": {},
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "WARNING:py.warnings:/opt/conda/lib/python3.11/site-packages/great_expectations/expectations/expectation.py:1518: UserWarning: `result_format` configured at the Validator-level will not be persisted. Please add the configuration to your Checkpoint config or checkpoint_run() method instead.\n",
      "  warnings.warn(\n",
      "\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "--- 'kma_data_rules'에 대한 검사 규칙 추가 중 ---\n"
     ]
    },
    {
     "data": {
      "application/vnd.jupyter.widget-view+json": {
       "model_id": "24db3e459dd143d4a9ec96bceae2b812",
       "version_major": 2,
       "version_minor": 0
      },
      "text/plain": [
       "Calculating Metrics:   0%|          | 0/2 [00:00<?, ?it/s]"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "WARNING:py.warnings:/opt/conda/lib/python3.11/site-packages/great_expectations/expectations/expectation.py:1518: UserWarning: `result_format` configured at the Validator-level will not be persisted. Please add the configuration to your Checkpoint config or checkpoint_run() method instead.\n",
      "  warnings.warn(\n",
      "\n"
     ]
    },
    {
     "data": {
      "application/vnd.jupyter.widget-view+json": {
       "model_id": "300b6f1d8a8245b9a66d20850da2e31c",
       "version_major": 2,
       "version_minor": 0
      },
      "text/plain": [
       "Calculating Metrics:   0%|          | 0/6 [00:00<?, ?it/s]"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "WARNING:py.warnings:/opt/conda/lib/python3.11/site-packages/great_expectations/expectations/expectation.py:1518: UserWarning: `result_format` configured at the Validator-level will not be persisted. Please add the configuration to your Checkpoint config or checkpoint_run() method instead.\n",
      "  warnings.warn(\n",
      "\n"
     ]
    },
    {
     "data": {
      "application/vnd.jupyter.widget-view+json": {
       "model_id": "c26cb3a8e42040998ca00bc9a2f75b8c",
       "version_major": 2,
       "version_minor": 0
      },
      "text/plain": [
       "Calculating Metrics:   0%|          | 0/8 [00:00<?, ?it/s]"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "WARNING:py.warnings:/opt/conda/lib/python3.11/site-packages/great_expectations/expectations/expectation.py:1518: UserWarning: `result_format` configured at the Validator-level will not be persisted. Please add the configuration to your Checkpoint config or checkpoint_run() method instead.\n",
      "  warnings.warn(\n",
      "\n"
     ]
    },
    {
     "data": {
      "application/vnd.jupyter.widget-view+json": {
       "model_id": "adf8577858e643bc8cef0b223793e2b6",
       "version_major": 2,
       "version_minor": 0
      },
      "text/plain": [
       "Calculating Metrics:   0%|          | 0/8 [00:00<?, ?it/s]"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "WARNING:py.warnings:/opt/conda/lib/python3.11/site-packages/great_expectations/expectations/expectation.py:1518: UserWarning: `result_format` configured at the Validator-level will not be persisted. Please add the configuration to your Checkpoint config or checkpoint_run() method instead.\n",
      "  warnings.warn(\n",
      "\n"
     ]
    },
    {
     "data": {
      "application/vnd.jupyter.widget-view+json": {
       "model_id": "84261af821eb40d198cbf5dd88d3f76c",
       "version_major": 2,
       "version_minor": 0
      },
      "text/plain": [
       "Calculating Metrics:   0%|          | 0/8 [00:00<?, ?it/s]"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "'kma_data_rules' 저장 완료!\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "WARNING:py.warnings:/opt/conda/lib/python3.11/site-packages/great_expectations/expectations/expectation.py:1518: UserWarning: `result_format` configured at the Validator-level will not be persisted. Please add the configuration to your Checkpoint config or checkpoint_run() method instead.\n",
      "  warnings.warn(\n",
      "\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "\n",
      "--- 'airkorea_data_rules'에 대한 검사 규칙 추가 중 ---\n"
     ]
    },
    {
     "data": {
      "application/vnd.jupyter.widget-view+json": {
       "model_id": "2bece4af03264a9888b235e5a5f7d50f",
       "version_major": 2,
       "version_minor": 0
      },
      "text/plain": [
       "Calculating Metrics:   0%|          | 0/2 [00:00<?, ?it/s]"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "WARNING:py.warnings:/opt/conda/lib/python3.11/site-packages/great_expectations/expectations/expectation.py:1518: UserWarning: `result_format` configured at the Validator-level will not be persisted. Please add the configuration to your Checkpoint config or checkpoint_run() method instead.\n",
      "  warnings.warn(\n",
      "\n"
     ]
    },
    {
     "data": {
      "application/vnd.jupyter.widget-view+json": {
       "model_id": "fa51a60e91214f5182bcea215ae72669",
       "version_major": 2,
       "version_minor": 0
      },
      "text/plain": [
       "Calculating Metrics:   0%|          | 0/6 [00:00<?, ?it/s]"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "WARNING:py.warnings:/opt/conda/lib/python3.11/site-packages/great_expectations/expectations/expectation.py:1518: UserWarning: `result_format` configured at the Validator-level will not be persisted. Please add the configuration to your Checkpoint config or checkpoint_run() method instead.\n",
      "  warnings.warn(\n",
      "\n"
     ]
    },
    {
     "data": {
      "application/vnd.jupyter.widget-view+json": {
       "model_id": "67f6ebead1cf405d98a1f32edab98f5a",
       "version_major": 2,
       "version_minor": 0
      },
      "text/plain": [
       "Calculating Metrics:   0%|          | 0/8 [00:00<?, ?it/s]"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "'airkorea_data_rules' 저장 완료!\n"
     ]
    }
   ],
   "source": [
    "import great_expectations as gx\n",
    "from great_expectations.core.batch import BatchRequest\n",
    "import os\n",
    "import glob\n",
    "import logging\n",
    "\n",
    "# --- 헬퍼 함수: 특정 패턴에 맞는 가장 최신 파일을 찾습니다 ---\n",
    "def get_latest_file_asset_name(path_pattern: str) -> str:\n",
    "    \"\"\"\n",
    "    주어진 경로 패턴과 일치하는 파일 중 가장 최신 파일의 이름을\n",
    "    '.csv' 확장자를 제외하고 반환합니다.\n",
    "    \"\"\"\n",
    "    list_of_files = glob.glob(path_pattern)\n",
    "    if not list_of_files:\n",
    "        raise FileNotFoundError(f\"데이터 파일을 찾을 수 없습니다. 경로 패턴을 확인하세요: {path_pattern}\")\n",
    "    \n",
    "    latest_file = max(list_of_files, key=os.path.getctime)\n",
    "    logging.info(f\"가장 최신 파일: {latest_file}\")\n",
    "    \n",
    "    # 파일 경로에서 이름만 추출하고, 확장자(.csv)를 제거하여 데이터 자산 이름으로 사용\n",
    "    asset_name = os.path.basename(latest_file).replace(\".csv\", \"\")\n",
    "    return asset_name\n",
    "\n",
    "# 1. Great Expectations 데이터 컨텍스트(프로젝트)를 불러옵니다.\n",
    "context = gx.get_context(context_root_dir=\"/home/jovyan/notebooks/gx\")\n",
    "\n",
    "# 2. 데이터를 검사할 데이터 소스(Datasource)를 선택합니다.\n",
    "datasource_name = \"airflow_data\"\n",
    "datasource = context.get_datasource(datasource_name)\n",
    "\n",
    "# --- 기상 데이터(kma)에 대한 Expectation Suite 생성 ---\n",
    "try:\n",
    "    # 3. [수정] 가장 최신 기상 데이터 파일의 자산 이름을 동적으로 찾습니다.\n",
    "    kma_asset_name = get_latest_file_asset_name(\"/opt/airflow/data/kma_short_forecast_*.csv\")\n",
    "    kma_suite_name = \"kma_data_rules\"\n",
    "\n",
    "    # 4. 데이터 자산에 대한 Batch Request를 생성합니다.\n",
    "    kma_batch_request = BatchRequest(\n",
    "        datasource_name=datasource_name,\n",
    "        data_connector_name=\"default_inferred_data_connector_name\",\n",
    "        data_asset_name=kma_asset_name, # 동적으로 찾은 자산 이름을 사용\n",
    "    )\n",
    "\n",
    "    # 5. 새로운 Expectation Suite를 생성하거나, 이미 존재하면 불러옵니다.\n",
    "    context.add_or_update_expectation_suite(expectation_suite_name=kma_suite_name)\n",
    "\n",
    "    # 6. Validator를 사용하여 데이터에 대한 검사 규칙(기대치)을 추가합니다.\n",
    "    kma_validator = context.get_validator(\n",
    "        batch_request=kma_batch_request,\n",
    "        expectation_suite_name=kma_suite_name,\n",
    "    )\n",
    "\n",
    "    print(f\"--- '{kma_suite_name}'에 대한 검사 규칙 추가 중 ---\")\n",
    "\n",
    "    kma_validator.expect_column_to_exist(\"category\")\n",
    "    kma_validator.expect_column_values_to_not_be_null(\"fcstValue\")\n",
    "    kma_validator.expect_column_values_to_be_in_set(\"category\", [\"T1H\", \"RN1\", \"SKY\", \"REH\", \"PTY\", \"VEC\", \"WSD\"])\n",
    "    kma_validator.expect_column_values_to_be_between(\"nx\", 1, 200)\n",
    "    kma_validator.expect_column_values_to_be_between(\"ny\", 1, 200)\n",
    "\n",
    "    # 7. 추가된 모든 규칙을 Suite에 최종 저장합니다.\n",
    "    kma_validator.save_expectation_suite(discard_failed_expectations=False)\n",
    "    print(f\"'{kma_suite_name}' 저장 완료!\")\n",
    "\n",
    "except FileNotFoundError as e:\n",
    "    print(f\"[경고] 기상 데이터 파일을 찾을 수 없어 kma_data_rules 생성을 건너뜁니다. 에러: {e}\")\n",
    "\n",
    "\n",
    "# --- 대기질 데이터(airkorea)에 대한 Expectation Suite 생성 (동일한 방식) ---\n",
    "try:\n",
    "    # [수정] 가장 최신 대기질 데이터 파일의 자산 이름을 동적으로 찾습니다.\n",
    "    airkorea_asset_name = get_latest_file_asset_name(\"/opt/airflow/data/airkorea_air_quality_*.csv\")\n",
    "    airkorea_suite_name = \"airkorea_data_rules\"\n",
    "\n",
    "    airkorea_batch_request = BatchRequest(\n",
    "        datasource_name=datasource_name,\n",
    "        data_connector_name=\"default_inferred_data_connector_name\",\n",
    "        data_asset_name=airkorea_asset_name, # 동적으로 찾은 자산 이름을 사용\n",
    "    )\n",
    "\n",
    "    context.add_or_update_expectation_suite(expectation_suite_name=airkorea_suite_name)\n",
    "\n",
    "    airkorea_validator = context.get_validator(\n",
    "        batch_request=airkorea_batch_request,\n",
    "        expectation_suite_name=airkorea_suite_name,\n",
    "    )\n",
    "\n",
    "    print(f\"\\n--- '{airkorea_suite_name}'에 대한 검사 규칙 추가 중 ---\")\n",
    "\n",
    "    airkorea_validator.expect_column_to_exist(\"informCode\")\n",
    "    airkorea_validator.expect_column_values_to_not_be_null(\"informGrade\")\n",
    "    airkorea_validator.expect_column_values_to_be_in_set(\"informCode\", [\"PM10\", \"PM25\"])\n",
    "\n",
    "    airkorea_validator.save_expectation_suite(discard_failed_expectations=False)\n",
    "    print(f\"'{airkorea_suite_name}' 저장 완료!\")\n",
    "\n",
    "except FileNotFoundError as e:\n",
    "    print(f\"[경고] 대기질 데이터 파일을 찾을 수 없어 airkorea_data_rules 생성을 건너뜁니다. 에러: {e}\")\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "194c5c8c-6092-4359-a7fe-3716ade26810",
   "metadata": {},
   "outputs": [],
   "source": []
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3 (ipykernel)",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.11.6"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 5
}
